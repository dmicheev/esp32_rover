<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Robot Control Panel</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
      padding: 20px;
      color: #fff;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      margin-bottom: 30px;
      color: #00d9ff;
      text-shadow: 0 0 10px rgba(0, 217, 255, 0.5);
    }

    .status-bar {
      background: rgba(255, 255, 255, 0.1);
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .btn-ota {
      background: linear-gradient(135deg, #00d9ff, #00ff88);
      color: #1a1a2e;
      padding: 8px 16px;
      border-radius: 6px;
      text-decoration: none;
      font-weight: bold;
      font-size: 14px;
      transition: all 0.2s;
      box-shadow: 0 2px 10px rgba(0, 217, 255, 0.3);
    }

    .btn-ota:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0, 217, 255, 0.5);
    }

    /* ===== –ó–∞–∫–ª–∞–¥–∫–∏ (Tabs) ===== */
    .tabs-container {
      margin-bottom: 20px;
    }

    .tabs {
      display: flex;
      gap: 10px;
      background: rgba(255, 255, 255, 0.05);
      padding: 10px;
      border-radius: 10px;
      margin-bottom: 20px;
    }

    .tab-button {
      flex: 1;
      padding: 15px 30px;
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid transparent;
      border-radius: 8px;
      color: #aaa;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }

    .tab-button:hover {
      background: rgba(255, 255, 255, 0.15);
      color: #fff;
    }

    .tab-button.active {
      background: rgba(0, 217, 255, 0.2);
      border-color: #00d9ff;
      color: #00d9ff;
      box-shadow: 0 0 15px rgba(0, 217, 255, 0.3);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ===== –î–∂–æ–π—Å—Ç–∏–∫ ===== */
    .joystick-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-top: 30px;
    }

    .joystick-panel {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 15px;
      padding: 30px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .joystick-panel h2 {
      color: #00d9ff;
      margin-bottom: 20px;
      text-align: center;
    }

    .joystick-control {
      position: relative;
      width: 200px;
      height: 200px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      border: 3px solid rgba(0, 217, 255, 0.3);
      touch-action: none;
    }

    .joystick-knob {
      position: absolute;
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #00d9ff, #00ff88);
      border-radius: 50%;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0, 217, 255, 0.5);
      transition: box-shadow 0.2s;
    }

    .joystick-knob:active {
      box-shadow: 0 6px 20px rgba(0, 217, 255, 0.8);
    }

    .joystick-values {
      margin-top: 20px;
      text-align: center;
    }

    .joystick-values .value-display {
      font-size: 18px;
      color: #00ff88;
      margin: 5px 0;
    }

    /* ===== –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ä–æ–≤–µ—Ä–∞ ===== */
    .rover-visualizer {
      margin: 20px 0;
      display: flex;
      justify-content: center;
    }

    .rover-svg {
      width: 100%;
      max-width: 260px;
      height: auto;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      border: 1px solid rgba(0, 217, 255, 0.2);
    }

    .wheel {
      transition: all 0.1s ease;
    }

    /* –°—Ç—Ä–µ–ª–∫–∞ —Å–µ—Ä–≤–æ–ø—Ä–∏–≤–æ–¥–∞ */
    .servo-arrow {
      transition: transform 0.15s ease-out;
    }

    /* –°—Ç—Ä–µ–ª–∫–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏ */
    .speed-arrow-line {
      transition: all 0.1s ease-out;
    }

    /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ */
    .wheel-active-left {
      fill: rgba(255, 107, 107, 0.5) !important;
      stroke: #ff6b6b !important;
      filter: drop-shadow(0 0 8px #ff6b6b);
    }

    .wheel-active-right {
      fill: rgba(0, 255, 136, 0.5) !important;
      stroke: #00ff88 !important;
      filter: drop-shadow(0 0 8px #00ff88);
    }

    .servo-active {
      fill: rgba(255, 204, 0, 0.8) !important;
      stroke: #ffcc00 !important;
      filter: drop-shadow(0 0 8px #ffcc00);
    }

    .mode-selector {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      justify-content: center;
    }

    .mode-btn {
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid transparent;
      border-radius: 8px;
      color: #aaa;
      cursor: pointer;
      transition: all 0.2s;
    }

    .mode-btn:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    .mode-btn.active {
      background: rgba(0, 217, 255, 0.2);
      border-color: #00d9ff;
      color: #00d9ff;
    }

    .motor-status-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-top: 20px;
    }

    .motor-status-item {
      background: rgba(255, 255, 255, 0.05);
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }

    .motor-status-item h4 {
      color: #ffcc00;
      margin-bottom: 10px;
      font-size: 16px;
    }

    .motor-status-value {
      font-size: 24px;
      font-weight: bold;
      color: #00ff88;
    }

    .status-led {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #00ff88;
      box-shadow: 0 0 10px #00ff88;
    }

    .panel {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 25px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .panel h2 {
      margin-bottom: 20px;
      color: #00d9ff;
      border-bottom: 2px solid #00d9ff;
      padding-bottom: 10px;
    }

    .servo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
    }

    .servo-card {
      background: rgba(255, 255, 255, 0.08);
      border-radius: 10px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .servo-card h3 {
      margin-bottom: 15px;
      color: #ffcc00;
    }

    .servo-control {
      margin-bottom: 15px;
    }

    .servo-control label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      color: #aaa;
    }

    input[type="range"] {
      width: 100%;
      height: 8px;
      border-radius: 4px;
      background: #333;
      outline: none;
      -webkit-appearance: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #00d9ff;
      cursor: pointer;
      box-shadow: 0 0 10px rgba(0, 217, 255, 0.5);
    }

    .value-display {
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      color: #00d9ff;
      margin: 10px 0;
    }

    .motor-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }

    .motor-card {
      background: rgba(255, 255, 255, 0.08);
      border-radius: 10px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .motor-card h3 {
      margin-bottom: 15px;
      color: #ff6b6b;
    }

    .motor-controls {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 15px;
    }

    .motor-btn {
      flex: 1;
      padding: 15px;
      border: none;
      border-radius: 8px;
      font-size: 24px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-reverse {
      background: #ff6b6b;
      color: white;
    }

    .btn-reverse:hover {
      background: #ff5252;
    }

    .btn-stop {
      background: #888;
      color: white;
      flex: 0.5;
    }

    .btn-stop:hover {
      background: #666;
    }

    .btn-forward {
      background: #00ff88;
      color: #1a1a2e;
    }

    .btn-forward:hover {
      background: #00ff6a;
    }

    .motor-speed {
      text-align: center;
      font-size: 20px;
      font-weight: bold;
      color: #00ff88;
    }

    .motor-slider {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .motor-slider label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      color: #aaa;
    }

    .slider-value {
      text-align: center;
      font-size: 18px;
      font-weight: bold;
      color: #ffcc00;
      margin: 8px 0;
    }

    input[type="range"].motor-range {
      width: 100%;
      height: 10px;
      border-radius: 5px;
      background: linear-gradient(to right, #ff6b6b 0%, #888 50%, #00ff88 100%);
      outline: none;
      -webkit-appearance: none;
    }

    input[type="range"].motor-range::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #fff;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }

    .motor-slider-input {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-top: 10px;
    }

    .motor-slider-input input[type="number"] {
      flex: 1;
      padding: 8px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 5px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 16px;
      text-align: center;
    }

    .btn-apply-motor {
      padding: 8px 16px;
      background: #00d9ff;
      color: #1a1a2e;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.2s;
    }

    .btn-apply-motor:hover {
      background: #00e5ff;
      box-shadow: 0 0 10px rgba(0, 217, 255, 0.5);
    }

    .calibrate-section {
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .calibrate-section h4 {
      margin-bottom: 10px;
      color: #aaa;
      font-size: 14px;
    }

    .calibrate-inputs {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
     
    }

    .calibrate-inputs input {
      flex: 1;
      padding: 8px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 5px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 14px;
       width: 40%;
    }

    .btn-calibrate {
      width: 100%;
      padding: 10px;
      background: #ffcc00;
      color: #1a1a2e;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.2s;
    }

    .btn-calibrate:hover {
      background: #ffdb4d;
    }

    .btn-apply {
      width: 100%;
      padding: 12px;
      background: #00d9ff;
      color: #1a1a2e;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      font-size: 16px;
      margin-top: 10px;
      transition: all 0.2s;
    }

    .btn-apply:hover {
      background: #00e5ff;
      box-shadow: 0 0 15px rgba(0, 217, 255, 0.5);
    }

    .btn-stop-all {
      background: #ff4444;
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-stop-all:hover {
      background: #ff0000;
      box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
    }

    .motor-actions {
      display: flex;
      justify-content: center;
      margin-top: 20px;
    }

    .message {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      z-index: 1000;
      animation: slideIn 0.3s ease;
    }

    .message.success {
      background: #00ff88;
      color: #1a1a2e;
    }

    .message.error {
      background: #ff4444;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @media (max-width: 600px) {
      .status-bar {
        flex-direction: column;
        align-items: flex-start;
      }

      .motor-grid {
        grid-template-columns: 1fr;
      }

      .motor-controls {
        flex-direction: column;
      }

      .btn-stop {
        flex: 1;
      }
      
      .motor-slider-input {
        flex-direction: column;
      }
      
      .motor-slider-input input[type="number"] {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ü§ñ Robot Control Panel</h1>

    <div class="status-bar">
      <div class="status-item">
        <div class="status-led"></div>
        <span>System Online</span>
      </div>
      <div class="status-item">
        <span>IP: <strong id="robot-ip">Loading...</strong></span>
      </div>
      <div class="status-item">
        <a href="/api/ota" class="btn-ota" target="_blank">üîÑ OTA Update</a>
      </div>
    </div>

    <!-- –ó–∞–∫–ª–∞–¥–∫–∏ -->
    <div class="tabs-container">
      <div class="tabs">
        <button class="tab-button active" onclick="switchTab('parameters')">üéõÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä—ã</button>
        <button class="tab-button" onclick="switchTab('joystick')">üïπÔ∏è –î–∂–æ–π—Å—Ç–∏–∫</button>
      </div>
    </div>

    <!-- –í–∫–ª–∞–¥–∫–∞ 1: –ü–∞—Ä–∞–º–µ—Ç—Ä—ã -->
    <div id="tab-parameters" class="tab-content active">

    <!-- –°–µ—Ä–≤–æ–ø—Ä–∏–≤–æ–¥—ã -->
    <div class="panel">
      <h2>üîß –°–µ—Ä–≤–æ–ø—Ä–∏–≤–æ–¥—ã</h2>
      <div class="servo-grid">
        <div class="servo-card">
          <h3>Servo 0</h3>
          <div class="servo-control">
            <label>–£–≥–æ–ª: <span id="servo0-value">90</span>¬∞</label>
            <input type="range" id="servo0" min="0" max="180" value="90" oninput="updateServoValue(0, this.value)">
          </div>
          <button class="btn-apply" onclick="setServo(0)">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
          <div class="calibrate-section">
            <h4>–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞</h4>
            <div class="calibrate-inputs">
              <input type="number" id="servo0-min" placeholder="Min" value="140">
              <input type="number" id="servo0-max" placeholder="Max" value="480">
            </div>
            <button class="btn-calibrate" onclick="calibrateServo(0)">–ö–∞–ª–∏–±—Ä–æ–≤–∞—Ç—å</button>
          </div>
        </div>

        <div class="servo-card">
          <h3>Servo 1</h3>
          <div class="servo-control">
            <label>–£–≥–æ–ª: <span id="servo1-value">90</span>¬∞</label>
            <input type="range" id="servo1" min="0" max="180" value="90" oninput="updateServoValue(1, this.value)">
          </div>
          <button class="btn-apply" onclick="setServo(1)">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
          <div class="calibrate-section">
            <h4>–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞</h4>
            <div class="calibrate-inputs">
              <input type="number" id="servo1-min" placeholder="Min" value="140">
              <input type="number" id="servo1-max" placeholder="Max" value="480">
            </div>
            <button class="btn-calibrate" onclick="calibrateServo(1)">–ö–∞–ª–∏–±—Ä–æ–≤–∞—Ç—å</button>
          </div>
        </div>

        <div class="servo-card">
          <h3>Servo 2</h3>
          <div class="servo-control">
            <label>–£–≥–æ–ª: <span id="servo2-value">90</span>¬∞</label>
            <input type="range" id="servo2" min="0" max="180" value="90" oninput="updateServoValue(2, this.value)">
          </div>
          <button class="btn-apply" onclick="setServo(2)">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
          <div class="calibrate-section">
            <h4>–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞</h4>
            <div class="calibrate-inputs">
              <input type="number" id="servo2-min" placeholder="Min" value="140">
              <input type="number" id="servo2-max" placeholder="Max" value="480">
            </div>
            <button class="btn-calibrate" onclick="calibrateServo(2)">–ö–∞–ª–∏–±—Ä–æ–≤–∞—Ç—å</button>
          </div>
        </div>

        <div class="servo-card">
          <h3>Servo 3</h3>
          <div class="servo-control">
            <label>–£–≥–æ–ª: <span id="servo3-value">90</span>¬∞</label>
            <input type="range" id="servo3" min="0" max="180" value="90" oninput="updateServoValue(3, this.value)">
          </div>
          <button class="btn-apply" onclick="setServo(3)">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
          <div class="calibrate-section">
            <h4>–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞</h4>
            <div class="calibrate-inputs">
              <input type="number" id="servo3-min" placeholder="Min" value="140">
              <input type="number" id="servo3-max" placeholder="Max" value="480">
            </div>
            <button class="btn-calibrate" onclick="calibrateServo(3)">–ö–∞–ª–∏–±—Ä–æ–≤–∞—Ç—å</button>
          </div>
        </div>
      </div>
    </div>

    <!-- DC –ú–æ—Ç–æ—Ä—ã -->
    <div class="panel">
      <h2>üöó DC –ú–æ—Ç–æ—Ä—ã</h2>
      <div class="motor-grid">
        <div class="motor-card">
          <h3>Motor A</h3>
          <div class="motor-controls">
            <button class="motor-btn btn-reverse" onmousedown="startMotor('A', -255)" onmouseup="stopMotor('A')" ontouchstart="startMotor('A', -255)" ontouchend="stopMotor('A')">‚óÄ</button>
            <button class="motor-btn btn-stop" onclick="setMotorSpeed('A', 0)">‚ñ†</button>
            <button class="motor-btn btn-forward" onmousedown="startMotor('A', 255)" onmouseup="stopMotor('A')" ontouchstart="startMotor('A', 255)" ontouchend="stopMotor('A')">‚ñ∂</button>
          </div>
          <div class="motor-speed">–°–∫–æ—Ä–æ—Å—Ç—å: <span id="motorA-speed">0</span></div>
          <div class="motor-slider">
            <label>–¢–æ—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏:</label>
            <div class="slider-value"><span id="motorA-value">0</span></div>
            <input type="range" class="motor-range" id="motorA-range" min="-255" max="255" value="0" oninput="updateMotorValue('A', this.value)">
            <div class="motor-slider-input">
              <input type="number" id="motorA-input" min="-255" max="255" value="0" placeholder="-255...255">
              <button class="btn-apply-motor" onclick="setMotorFromSlider('A')">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            </div>
          </div>
        </div>

        <div class="motor-card">
          <h3>Motor B</h3>
          <div class="motor-controls">
            <button class="motor-btn btn-reverse" onmousedown="startMotor('B', -255)" onmouseup="stopMotor('B')" ontouchstart="startMotor('B', -255)" ontouchend="stopMotor('B')">‚óÄ</button>
            <button class="motor-btn btn-stop" onclick="setMotorSpeed('B', 0)">‚ñ†</button>
            <button class="motor-btn btn-forward" onmousedown="startMotor('B', 255)" onmouseup="stopMotor('B')" ontouchstart="startMotor('B', 255)" ontouchend="stopMotor('B')">‚ñ∂</button>
          </div>
          <div class="motor-speed">–°–∫–æ—Ä–æ—Å—Ç—å: <span id="motorB-speed">0</span></div>
          <div class="motor-slider">
            <label>–¢–æ—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏:</label>
            <div class="slider-value"><span id="motorB-value">0</span></div>
            <input type="range" class="motor-range" id="motorB-range" min="-255" max="255" value="0" oninput="updateMotorValue('B', this.value)">
            <div class="motor-slider-input">
              <input type="number" id="motorB-input" min="-255" max="255" value="0" placeholder="-255...255">
              <button class="btn-apply-motor" onclick="setMotorFromSlider('B')">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            </div>
          </div>
        </div>

        <div class="motor-card">
          <h3>Motor C</h3>
          <div class="motor-controls">
            <button class="motor-btn btn-reverse" onmousedown="startMotor('C', -255)" onmouseup="stopMotor('C')" ontouchstart="startMotor('C', -255)" ontouchend="stopMotor('C')">‚óÄ</button>
            <button class="motor-btn btn-stop" onclick="setMotorSpeed('C', 0)">‚ñ†</button>
            <button class="motor-btn btn-forward" onmousedown="startMotor('C', 255)" onmouseup="stopMotor('C')" ontouchstart="startMotor('C', 255)" ontouchend="stopMotor('C')">‚ñ∂</button>
          </div>
          <div class="motor-speed">–°–∫–æ—Ä–æ—Å—Ç—å: <span id="motorC-speed">0</span></div>
          <div class="motor-slider">
            <label>–¢–æ—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏:</label>
            <div class="slider-value"><span id="motorC-value">0</span></div>
            <input type="range" class="motor-range" id="motorC-range" min="-255" max="255" value="0" oninput="updateMotorValue('C', this.value)">
            <div class="motor-slider-input">
              <input type="number" id="motorC-input" min="-255" max="255" value="0" placeholder="-255...255">
              <button class="btn-apply-motor" onclick="setMotorFromSlider('C')">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            </div>
          </div>
        </div>

        <div class="motor-card">
          <h3>Motor D</h3>
          <div class="motor-controls">
            <button class="motor-btn btn-reverse" onmousedown="startMotor('D', -255)" onmouseup="stopMotor('D')" ontouchstart="startMotor('D', -255)" ontouchend="stopMotor('D')">‚óÄ</button>
            <button class="motor-btn btn-stop" onclick="setMotorSpeed('D', 0)">‚ñ†</button>
            <button class="motor-btn btn-forward" onmousedown="startMotor('D', 255)" onmouseup="stopMotor('D')" ontouchstart="startMotor('D', 255)" ontouchend="stopMotor('D')">‚ñ∂</button>
          </div>
          <div class="motor-speed">–°–∫–æ—Ä–æ—Å—Ç—å: <span id="motorD-speed">0</span></div>
          <div class="motor-slider">
            <label>–¢–æ—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏:</label>
            <div class="slider-value"><span id="motorD-value">0</span></div>
            <input type="range" class="motor-range" id="motorD-range" min="-255" max="255" value="0" oninput="updateMotorValue('D', this.value)">
            <div class="motor-slider-input">
              <input type="number" id="motorD-input" min="-255" max="255" value="0" placeholder="-255...255">
              <button class="btn-apply-motor" onclick="setMotorFromSlider('D')">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            </div>
          </div>
        </div>
      </div>

      <div class="motor-actions">
        <button class="btn-stop-all" onclick="stopAllMotors()">üõë –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –º–æ—Ç–æ—Ä—ã</button>
      </div>
      
      <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—Å–µ–º–∏ –º–æ—Ç–æ—Ä–∞–º–∏ -->
      <div class="panel" style="margin-top: 20px;">
        <h2>üéõÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—Å–µ–º–∏ –º–æ—Ç–æ—Ä–∞–º–∏</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
          <div>
            <label style="color: #aaa; font-size: 14px;">Motor A:</label>
            <input type="number" id="all-motorA" min="-255" max="255" value="0" style="width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 5px; background: rgba(255,255,255,0.1); color: white; font-size: 16px;">
          </div>
          <div>
            <label style="color: #aaa; font-size: 14px;">Motor B:</label>
            <input type="number" id="all-motorB" min="-255" max="255" value="0" style="width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 5px; background: rgba(255,255,255,0.1); color: white; font-size: 16px;">
          </div>
          <div>
            <label style="color: #aaa; font-size: 14px;">Motor C:</label>
            <input type="number" id="all-motorC" min="-255" max="255" value="0" style="width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 5px; background: rgba(255,255,255,0.1); color: white; font-size: 16px;">
          </div>
          <div>
            <label style="color: #aaa; font-size: 14px;">Motor D:</label>
            <input type="number" id="all-motorD" min="-255" max="255" value="0" style="width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 5px; background: rgba(255,255,255,0.1); color: white; font-size: 16px;">
          </div>
        </div>
        <button class="btn-apply" onclick="setAllMotors()" style="width: 100%;">üöÄ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫–æ—Ä–æ—Å—Ç—å –≤—Å–µ—Ö –º–æ—Ç–æ—Ä–æ–≤</button>
      </div>
    </div>
    </div>

    <!-- –í–∫–ª–∞–¥–∫–∞ 2: –î–∂–æ–π—Å—Ç–∏–∫ -->
    <div id="tab-joystick" class="tab-content">
      <div class="joystick-container">
        <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å: –î–∂–æ–π—Å—Ç–∏–∫ -->
        <div class="joystick-panel">
          <h2>üïπÔ∏è –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –¥–∂–æ–π—Å—Ç–∏–∫</h2>
          
          <div class="joystick-control" id="joystick">
            <div class="joystick-knob" id="joystick-knob"></div>
          </div>
          
          <div class="joystick-values">
            <div class="value-display">X: <span id="joy-x">0</span></div>
            <div class="value-display">Y: <span id="joy-y">0</span></div>
          </div>
          
          <div class="mode-selector">
            <button class="mode-btn active" onclick="setJoystickMode('drive')" data-mode="drive">üöó –ï–∑–¥–∞</button>
            <button class="mode-btn" onclick="setJoystickMode('servo')" data-mode="servo">üîß –°–µ—Ä–≤–æ</button>
            <button class="mode-btn" onclick="setJoystickMode('mixed')" data-mode="mixed">üéØ –ú–∏–∫—Å</button>
          </div>
        </div>
        
        <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å: –°—Ç–∞—Ç—É—Å –º–æ—Ç–æ—Ä–æ–≤ + –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è -->
        <div class="joystick-panel">
          <h2>üìä –°—Ç–∞—Ç—É—Å –º–æ—Ç–æ—Ä–æ–≤</h2>
          
          <!-- –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ä–æ–≤–µ—Ä–∞ -->
          <div class="rover-visualizer">
            <svg viewBox="0 0 260 380" class="rover-svg">
              <!-- –ö–æ—Ä–ø—É—Å —Ä–æ–≤–µ—Ä–∞ -->
              <rect x="105" y="160" width="50" height="80" rx="8" 
                    fill="rgba(0, 217, 255, 0.15)" 
                    stroke="#00d9ff" 
                    stroke-width="2"/>
              
              <!-- –ú–µ—Ç–∫–∞ –ø–µ—Ä–µ–¥–∞ -->
              <polygon points="130,145 125,155 135,155" 
                       fill="#00ff88"/>
              <text x="130" y="140" text-anchor="middle" 
                    fill="#00ff88" font-size="14" font-weight="bold">‚ñ≤</text>
              
              <!-- –õ–µ–≤—ã–µ –∫–æ–ª—ë—Å–∞ (B, C) -->
              <!-- –ö–æ–ª–µ—Å–æ B (–ø–µ—Ä–µ–¥–Ω–µ–µ –ª–µ–≤–æ–µ) -->
              <g id="wheel-b" transform="translate(70, 170)">
                <!-- –ö–æ–ª–µ—Å–æ -->
                <ellipse cx="0" cy="0" rx="18" ry="22" 
                         fill="rgba(255, 107, 107, 0.2)" 
                         stroke="#ff6b6b" 
                         stroke-width="2"
                         class="wheel"/>
                <!-- –°—Ç—Ä–µ–ª–∫–∞ –ø–æ–≤–æ—Ä–æ—Ç–∞ —Å–µ—Ä–≤–æ (—É–≥–æ–ª) -->
                <!-- –ü–æ–≤—ë—Ä–Ω—É—Ç–∞ –Ω–∞ -90¬∞ —á—Ç–æ–±—ã 90¬∞ = —Å—Ç—Ä–µ–ª–∫–∞ –≤–≤–µ—Ä—Ö (–≤–ø–µ—Ä—ë–¥) -->
                <g class="servo-arrow" transform="rotate(-90)">
                  <line x1="0" y1="0" x2="18" y2="0" 
                        stroke="#ffcc00" 
                        stroke-width="3"
                        stroke-linecap="round"/>
                  <polygon points="18,-4 22,0 18,4" 
                           fill="#ffcc00"/>
                  <text x="-14" y="4" fill="#ffcc00" font-size="8" font-weight="bold" class="servo-angle-text">90¬∞</text>
                </g>
                <!-- –¢–æ–ª—Å—Ç–∞—è —Å—Ç—Ä–µ–ª–∫–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏ (—Å–ª–µ–≤–∞ –æ—Ç –∫–æ–ª–µ—Å–∞) -->
                <g class="speed-arrow" transform="translate(-35, 0)">
                  <line x1="0" y1="0" x2="0" y2="0" 
                        stroke="#ff6b6b" 
                        stroke-width="6"
                        stroke-linecap="round"
                        class="speed-arrow-line"/>
                  <text x="0" y="-4" text-anchor="middle" 
                        fill="#ff6b6b" font-size="9" font-weight="bold" class="speed-text">0</text>
                </g>
                <!-- –ú–µ—Ç–∫–∞ -->
                <text x="-50" y="4" fill="#ff6b6b" font-size="11" font-weight="bold">B</text>
              </g>
              
              <!-- –ö–æ–ª–µ—Å–æ C (–∑–∞–¥–Ω–µ–µ –ª–µ–≤–æ–µ) -->
              <g id="wheel-c" transform="translate(70, 225)">
                <ellipse cx="0" cy="0" rx="18" ry="22" 
                         fill="rgba(255, 107, 107, 0.2)" 
                         stroke="#ff6b6b" 
                         stroke-width="2"
                         class="wheel"/>
                <g class="servo-arrow" transform="rotate(-90)">
                  <line x1="0" y1="0" x2="18" y2="0" 
                        stroke="#ffcc00" 
                        stroke-width="3"
                        stroke-linecap="round"/>
                  <polygon points="18,-4 22,0 18,4" 
                           fill="#ffcc00"/>
                  <text x="-14" y="4" fill="#ffcc00" font-size="8" font-weight="bold" class="servo-angle-text">90¬∞</text>
                </g>
                <g class="speed-arrow" transform="translate(-35, 0)">
                  <line x1="0" y1="0" x2="0" y2="0" 
                        stroke="#ff6b6b" 
                        stroke-width="6"
                        stroke-linecap="round"
                        class="speed-arrow-line"/>
                  <text x="0" y="-4" text-anchor="middle" 
                        fill="#ff6b6b" font-size="9" font-weight="bold" class="speed-text">0</text>
                </g>
                <text x="-50" y="4" fill="#ff6b6b" font-size="11" font-weight="bold">C</text>
              </g>
              
              <!-- –ü—Ä–∞–≤—ã–µ –∫–æ–ª—ë—Å–∞ (A, D) -->
              <!-- –ö–æ–ª–µ—Å–æ A (–ø–µ—Ä–µ–¥–Ω–µ–µ –ø—Ä–∞–≤–æ–µ) -->
              <g id="wheel-a" transform="translate(190, 170)">
                <ellipse cx="0" cy="0" rx="18" ry="22" 
                         fill="rgba(0, 255, 136, 0.2)" 
                         stroke="#00ff88" 
                         stroke-width="2"
                         class="wheel"/>
                <g class="servo-arrow" transform="rotate(-90)">
                  <line x1="0" y1="0" x2="-18" y2="0" 
                        stroke="#ffcc00" 
                        stroke-width="3"
                        stroke-linecap="round"/>
                  <polygon points="-18,-4 -22,0 -18,4" 
                           fill="#ffcc00"/>
                  <text x="14" y="4" fill="#ffcc00" font-size="8" font-weight="bold" class="servo-angle-text">90¬∞</text>
                </g>
                <g class="speed-arrow" transform="translate(35, 0)">
                  <line x1="0" y1="0" x2="0" y2="0" 
                        stroke="#00ff88" 
                        stroke-width="6"
                        stroke-linecap="round"
                        class="speed-arrow-line"/>
                  <text x="0" y="-4" text-anchor="middle" 
                        fill="#00ff88" font-size="9" font-weight="bold" class="speed-text">0</text>
                </g>
                <text x="55" y="4" fill="#00ff88" font-size="11" font-weight="bold">A</text>
              </g>
              
              <!-- –ö–æ–ª–µ—Å–æ D (–∑–∞–¥–Ω–µ–µ –ø—Ä–∞–≤–æ–µ) -->
              <g id="wheel-d" transform="translate(190, 225)">
                <ellipse cx="0" cy="0" rx="18" ry="22" 
                         fill="rgba(0, 255, 136, 0.2)" 
                         stroke="#00ff88" 
                         stroke-width="2"
                         class="wheel"/>
                <g class="servo-arrow" transform="rotate(-90)">
                  <line x1="0" y1="0" x2="-18" y2="0" 
                        stroke="#ffcc00" 
                        stroke-width="3"
                        stroke-linecap="round"/>
                  <polygon points="-18,-4 -22,0 -18,4" 
                           fill="#ffcc00"/>
                  <text x="14" y="4" fill="#ffcc00" font-size="8" font-weight="bold" class="servo-angle-text">90¬∞</text>
                </g>
                <g class="speed-arrow" transform="translate(35, 0)">
                  <line x1="0" y1="0" x2="0" y2="0" 
                        stroke="#00ff88" 
                        stroke-width="6"
                        stroke-linecap="round"
                        class="speed-arrow-line"/>
                  <text x="0" y="-4" text-anchor="middle" 
                        fill="#00ff88" font-size="9" font-weight="bold" class="speed-text">0</text>
                </g>
                <text x="55" y="4" fill="#00ff88" font-size="11" font-weight="bold">D</text>
              </g>
              
              <!-- –°–µ—Ä–≤–æ–ø—Ä–∏–≤–æ–¥—ã (–º–∞–ª–µ–Ω—å–∫–∏–µ –∫—Ä—É–∂–∫–∏ —É –∫–æ–ª—ë—Å) 
              <circle id="servo-0" cx="65" cy="172" r="5" 
                      fill="rgba(255, 204, 0, 0.4)" 
                      stroke="#ffcc00" 
                      stroke-width="2"/>
              <text x="65" y="186" text-anchor="middle" 
                    fill="#ffcc00" font-size="7" font-weight="bold">S0</text>
              
              <circle id="servo-1" cx="195" cy="172" r="5" 
                      fill="rgba(255, 204, 0, 0.4)" 
                      stroke="#ffcc00" 
                      stroke-width="2"/>
              <text x="195" y="186" text-anchor="middle" 
                    fill="#ffcc00" font-size="7" font-weight="bold">S1</text>
              
              <circle id="servo-2" cx="195" cy="233" r="5" 
                      fill="rgba(255, 204, 0, 0.4)" 
                      stroke="#ffcc00" 
                      stroke-width="2"/>
              <text x="195" y="247" text-anchor="middle" 
                    fill="#ffcc00" font-size="7" font-weight="bold">S2</text>
              
              <circle id="servo-3" cx="65" cy="233" r="5" 
                      fill="rgba(255, 204, 0, 0.4)" 
                      stroke="#ffcc00" 
                      stroke-width="2"/>
              <text x="65" y="247" text-anchor="middle" 
                    fill="#ffcc00" font-size="7" font-weight="bold">S3</text>
              -->
            </svg>
          </div>
          
          <div class="motor-status-grid">
            <div class="motor-status-item">
              <h4>Motor A</h4>
              <div class="motor-status-value" id="joy-motorA">0</div>
            </div>
            <div class="motor-status-item">
              <h4>Motor B</h4>
              <div class="motor-status-value" id="joy-motorB">0</div>
            </div>
            <div class="motor-status-item">
              <h4>Motor C</h4>
              <div class="motor-status-value" id="joy-motorC">0</div>
            </div>
            <div class="motor-status-item">
              <h4>Motor D</h4>
              <div class="motor-status-value" id="joy-motorD">0</div>
            </div>
          </div>

          <div style="margin-top: 30px; text-align: center;">
            <button class="btn-stop-all" onclick="stopAllMotorsFromJoystick()" style="padding: 15px 40px; font-size: 18px;">üõë –°–¢–û–ü</button>
          </div>

          <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
            <h4 style="color: #00d9ff; margin-bottom: 10px;">üí° –ü–æ–¥—Å–∫–∞–∑–∫–∏:</h4>
            <ul style="color: #aaa; font-size: 14px; line-height: 1.8; padding-left: 20px;">
              <li>–ü–µ—Ä–µ–º–µ—â–∞–π—Ç–µ –¥–∂–æ–π—Å—Ç–∏–∫ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</li>
              <li>–†–µ–∂–∏–º "–ï–∑–¥–∞" - —Ç–∞–Ω–∫–æ–≤–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ—Ç–æ—Ä–∞–º–∏</li>
              <li>–†–µ–∂–∏–º "–°–µ—Ä–≤–æ" - –ø–æ–≤–æ—Ä–æ—Ç –≤—Å–µ—Ö –∫–æ–ª—ë—Å (X –æ—Å—å)</li>
              <li>–†–µ–∂–∏–º "–ú–∏–∫—Å" - –ø–æ–≤–æ—Ä–æ—Ç (X) + —Å–∫–æ—Ä–æ—Å—Ç—å (Y)</li>
              <li>–ö–Ω–æ–ø–∫–∞ "–°–¢–û–ü" –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤—Å–µ –º–æ—Ç–æ—Ä—ã</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    </div>
  </div>

  <script src="joystick.js"></script>
  <script>
    const API_BASE = window.location.origin;

    // ===== –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∑–∞–∫–ª–∞–¥–æ–∫ =====
    function switchTab(tabName) {
      // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –∑–∞–∫–ª–∞–¥–∫–∏
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });

      // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –∫–Ω–æ–ø–æ–∫
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
      });

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é –∑–∞–∫–ª–∞–¥–∫—É
      document.getElementById('tab-' + tabName).classList.add('active');

      // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
      event.target.classList.add('active');

      // –ï—Å–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–∏–ª–∏—Å—å –Ω–∞ –¥–∂–æ–π—Å—Ç–∏–∫ - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º
      if (tabName === 'joystick') {
        initJoystick();
      }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è —Å–µ—Ä–≤–æ–ø—Ä–∏–≤–æ–¥–∞
    function updateServoValue(id, value) {
      document.getElementById('servo' + id + '-value').textContent = value;
    }

    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —É–≥–ª–∞ —Å–µ—Ä–≤–æ–ø—Ä–∏–≤–æ–¥–∞
    async function setServo(id) {
      const angle = document.getElementById('servo' + id).value;
      try {
        const response = await fetch(API_BASE + '/api/servo', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: id, angle: parseInt(angle) })
        });
        const result = await response.json();
        if (result.success) {
          showMessage('Servo ' + id + ' —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ ' + angle + '¬∞', 'success');
        } else {
          showMessage('–û—à–∏–±–∫–∞: ' + result.error, 'error');
        }
      } catch (error) {
        showMessage('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + error, 'error');
      }
    }

    // –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ —Å–µ—Ä–≤–æ–ø—Ä–∏–≤–æ–¥–∞
    async function calibrateServo(id) {
      const minVal = document.getElementById('servo' + id + '-min').value;
      const maxVal = document.getElementById('servo' + id + '-max').value;
      try {
        const response = await fetch(API_BASE + '/api/servo/calibrate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: id, min: parseInt(minVal), max: parseInt(maxVal) })
        });
        const result = await response.json();
        if (result.success) {
          showMessage('Servo ' + id + ' –æ—Ç–∫–∞–ª–∏–±—Ä–æ–≤–∞–Ω', 'success');
        } else {
          showMessage('–û—à–∏–±–∫–∞: ' + result.error, 'error');
        }
      } catch (error) {
        showMessage('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + error, 'error');
      }
    }

    // –ó–∞–ø—É—Å–∫ –º–æ—Ç–æ—Ä–∞
    async function startMotor(motor, speed) {
      try {
        const response = await fetch(API_BASE + '/api/motor', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ['motor' + motor]: speed })
        });
        const result = await response.json();
        if (result.success) {
          document.getElementById('motor' + motor + '-speed').textContent = speed;
          // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–∑—É–Ω–æ–∫ –∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞
          updateMotorValue(motor, speed);
        }
      } catch (error) {
        showMessage('–û—à–∏–±–∫–∞: ' + error, 'error');
      }
    }

    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏ –º–æ—Ç–æ—Ä–∞
    async function setMotorSpeed(motor, speed) {
      try {
        const response = await fetch(API_BASE + '/api/motor', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ['motor' + motor]: speed })
        });
        const result = await response.json();
        if (result.success) {
          document.getElementById('motor' + motor + '-speed').textContent = speed;
          // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–∑—É–Ω–æ–∫ –∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞
          updateMotorValue(motor, speed);
        }
      } catch (error) {
        showMessage('–û—à–∏–±–∫–∞: ' + error, 'error');
      }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏ –º–æ—Ç–æ—Ä–∞ (–ø–æ–ª–∑—É–Ω–æ–∫ + –ø–æ–ª–µ –≤–≤–æ–¥–∞)
    function updateMotorValue(motor, value) {
      document.getElementById('motor' + motor + '-value').textContent = value;
      document.getElementById('motor' + motor + '-range').value = value;
      document.getElementById('motor' + motor + '-input').value = value;
    }

    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏ –º–æ—Ç–æ—Ä–∞ –∏–∑ –ø–æ–ª–∑—É–Ω–∫–∞
    async function setMotorFromSlider(motor) {
      const speed = parseInt(document.getElementById('motor' + motor + '-input').value);
      if (speed < -255 || speed > 255) {
        showMessage('–û—à–∏–±–∫–∞: —Å–∫–æ—Ä–æ—Å—Ç—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç -255 –¥–æ 255', 'error');
        return;
      }
      try {
        const response = await fetch(API_BASE + '/api/motor', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ['motor' + motor]: speed })
        });
        const result = await response.json();
        if (result.success) {
          document.getElementById('motor' + motor + '-speed').textContent = speed;
          showMessage('Motor ' + motor + ' —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ ' + speed, 'success');
        } else {
          showMessage('–û—à–∏–±–∫–∞: ' + result.error, 'error');
        }
      } catch (error) {
        showMessage('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + error, 'error');
      }
    }

    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏ –≤—Å–µ—Ö –º–æ—Ç–æ—Ä–æ–≤ —Å—Ä–∞–∑—É
    async function setAllMotors() {
      const motorA = parseInt(document.getElementById('all-motorA').value) || 0;
      const motorB = parseInt(document.getElementById('all-motorB').value) || 0;
      const motorC = parseInt(document.getElementById('all-motorC').value) || 0;
      const motorD = parseInt(document.getElementById('all-motorD').value) || 0;
      
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–∞
      if ([motorA, motorB, motorC, motorD].some(s => s < -255 || s > 255)) {
        showMessage('–û—à–∏–±–∫–∞: —Å–∫–æ—Ä–æ—Å—Ç—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç -255 –¥–æ 255', 'error');
        return;
      }
      
      try {
        const response = await fetch(API_BASE + '/api/motor', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            motorA: motorA,
            motorB: motorB,
            motorC: motorC,
            motorD: motorD
          })
        });
        const result = await response.json();
        if (result.success) {
          // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Å–µ—Ö –º–æ—Ç–æ—Ä–æ–≤
          document.getElementById('motorA-speed').textContent = motorA;
          document.getElementById('motorB-speed').textContent = motorB;
          document.getElementById('motorC-speed').textContent = motorC;
          document.getElementById('motorD-speed').textContent = motorD;
          // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–∑—É–Ω–∫–∏
          updateMotorValue('A', motorA);
          updateMotorValue('B', motorB);
          updateMotorValue('C', motorC);
          updateMotorValue('D', motorD);
          showMessage('–í—Å–µ –º–æ—Ç–æ—Ä—ã —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã: A=' + motorA + ', B=' + motorB + ', C=' + motorC + ', D=' + motorD, 'success');
        } else {
          showMessage('–û—à–∏–±–∫–∞: ' + result.error, 'error');
        }
      } catch (error) {
        showMessage('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + error, 'error');
      }
    }

    // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–æ—Ç–æ—Ä–∞ (–æ—Ç–ø—É—Å–∫–∞–Ω–∏–µ –∫–Ω–æ–ø–∫–∏)
    function stopMotor(motor) {
      // –ú–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å —Å–∫–æ—Ä–æ—Å—Ç—å –∏–ª–∏ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å - –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ª–æ–≥–∏–∫–∏
      // –°–µ–π—á–∞—Å –æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å
    }

    // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –º–æ—Ç–æ—Ä–æ–≤
    async function stopAllMotors() {
      try {
        const response = await fetch(API_BASE + '/api/motor/stop', {
          method: 'POST'
        });
        const result = await response.json();
        if (result.success) {
          document.getElementById('motorA-speed').textContent = '0';
          document.getElementById('motorB-speed').textContent = '0';
          showMessage('–í—Å–µ –º–æ—Ç–æ—Ä—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã', 'success');
        }
      } catch (error) {
        showMessage('–û—à–∏–±–∫–∞: ' + error, 'error');
      }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–∏—Å—Ç–µ–º—ã
    async function loadStatus() {
      try {
        const response = await fetch(API_BASE + '/api/status');
        const result = await response.json();
        document.getElementById('robot-ip').textContent = result.ip || 'N/A';
      } catch (error) {
        document.getElementById('robot-ip').textContent = 'Connection error';
      }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ä–≤–æ–ø—Ä–∏–≤–æ–¥–æ–≤
    async function loadServos() {
      try {
        const response = await fetch(API_BASE + '/api/servo');
        const result = await response.json();
        if (result.servos) {
          result.servos.forEach(servo => {
            const id = servo.id;
            document.getElementById('servo' + id).value = servo.angle;
            document.getElementById('servo' + id + '-value').textContent = servo.angle;
            document.getElementById('servo' + id + '-min').value = servo.min;
            document.getElementById('servo' + id + '-max').value = servo.max;
          });
        }
      } catch (error) {
        console.error('Error loading servos:', error);
      }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–æ—Ç–æ—Ä–æ–≤
    async function loadMotors() {
      try {
        const response = await fetch(API_BASE + '/api/motor');
        const result = await response.json();
        const motorA = result.motorA || 0;
        const motorB = result.motorB || 0;
        const motorC = result.motorC || 0;
        const motorD = result.motorD || 0;
        
        document.getElementById('motorA-speed').textContent = motorA;
        document.getElementById('motorB-speed').textContent = motorB;
        document.getElementById('motorC-speed').textContent = motorC;
        document.getElementById('motorD-speed').textContent = motorD;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–∑—É–Ω–∫–∏ –∏ –ø–æ–ª—è –≤–≤–æ–¥–∞
        updateMotorValue('A', motorA);
        updateMotorValue('B', motorB);
        updateMotorValue('C', motorC);
        updateMotorValue('D', motorD);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—Å–µ—Ö –º–æ—Ç–æ—Ä–æ–≤
        document.getElementById('all-motorA').value = motorA;
        document.getElementById('all-motorB').value = motorB;
        document.getElementById('all-motorC').value = motorC;
        document.getElementById('all-motorD').value = motorD;
      } catch (error) {
        console.error('Error loading motors:', error);
      }
    }

    // –ü–æ–∫–∞–∑ —Å–æ–æ–±—â–µ–Ω–∏—è
    function showMessage(text, type) {
      const existing = document.querySelector('.message');
      if (existing) existing.remove();

      const msg = document.createElement('div');
      msg.className = 'message ' + type;
      msg.textContent = text;
      document.body.appendChild(msg);

      setTimeout(() => msg.remove(), 3000);
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    window.onload = function() {
      loadStatus();
      loadServos();
      loadMotors();

      // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
      setInterval(loadStatus, 5000);
    };

    // ===== –§—É–Ω–∫—Ü–∏–∏ –¥–∂–æ–π—Å—Ç–∏–∫–∞ =====
    let joystickInterval = null;
    let currentJoystickMode = 'drive';
    let lastMotorCommand = null;
    let lastSendTime = 0;
    const SEND_INTERVAL = 100; // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –æ—Ç–ø—Ä–∞–≤–∫–∞–º–∏ (–º—Å)
    
    // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ä–≤–æ–ø—Ä–∏–≤–æ–¥–æ–≤ –¥–ª—è —Ä–µ–∂–∏–º–∞ servo
    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: 0-B(–ª–µ–≤), 1-A(–ø—Ä–∞–≤), 2-D(–ø—Ä–∞–≤), 3-C(–ª–µ–≤)
    // –õ–µ–≤—ã–µ: 0, 3 | –ü—Ä–∞–≤—ã–µ: 1, 2
    let servoAngles = {
      servo0: 90,  // –ú–æ—Ç–æ—Ä B - –ª–µ–≤—ã–π
      servo1: 90,  // –ú–æ—Ç–æ—Ä A - –ø—Ä–∞–≤—ã–π
      servo2: 90,  // –ú–æ—Ç–æ—Ä D - –ø—Ä–∞–≤—ã–π
      servo3: 90   // –ú–æ—Ç–æ—Ä C - –ª–µ–≤—ã–π
    };
    let lastServoCommand = null;

    function initJoystick() {
      const joystick = document.getElementById('joystick');
      const knob = document.getElementById('joystick-knob');
      let isDragging = false;
      const maxRadius = 70; // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –¥–∂–æ–π—Å—Ç–∏–∫–∞

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –º—ã—à–∏
      knob.addEventListener('mousedown', startDrag);
      document.addEventListener('mousemove', drag);
      document.addEventListener('mouseup', endDrag);

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ touch
      knob.addEventListener('touchstart', startDrag);
      document.addEventListener('touchmove', drag);
      document.addEventListener('touchend', endDrag);

      function startDrag(e) {
        isDragging = true;
        knob.style.transition = 'none';
        console.log('[Joystick] Drag started');
      }

      function drag(e) {
        if (!isDragging) return;
        e.preventDefault();

        const rect = joystick.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;

        let clientX, clientY;
        if (e.touches) {
          clientX = e.touches[0].clientX;
          clientY = e.touches[0].clientY;
        } else {
          clientX = e.clientX;
          clientY = e.clientY;
        }

        let dx = clientX - centerX;
        let dy = clientY - centerY;
        const distance = Math.sqrt(dx * dx + dy * dy);

        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–≤–∏–∂–µ–Ω–∏–µ –∫—Ä—É–≥–æ–º
        if (distance > maxRadius) {
          const angle = Math.atan2(dy, dx);
          dx = Math.cos(angle) * maxRadius;
          dy = Math.sin(angle) * maxRadius;
        }

        knob.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;

        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –∑–Ω–∞—á–µ–Ω–∏—è -100...100
        const x = Math.round((dx / maxRadius) * 100);
        const y = Math.round(-(dy / maxRadius) * 100); // –ò–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º Y

        updateJoystickDisplay(x, y);
        updateJoystickControl(x, y);
      }

      function endDrag() {
        isDragging = false;
        knob.style.transition = 'box-shadow 0.2s, transform 0.3s';
        knob.style.transform = 'translate(-50%, -50%)';
        updateJoystickDisplay(0, 0);
        console.log('[Joystick] Drag ended - stopping motors');
        stopMotorsSmooth();
      }
    }

    function updateJoystickDisplay(x, y) {
      document.getElementById('joy-x').textContent = x;
      document.getElementById('joy-y').textContent = y;
    }

    function updateJoystickControl(x, y) {
      const now = Date.now();

      // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —á–∞—Å—Ç–æ—Ç—É –æ—Ç–ø—Ä–∞–≤–æ–∫ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
      if (now - lastSendTime < SEND_INTERVAL) return;

      if (currentJoystickMode === 'drive') {
        const motors = calculateTankDrive(x, y);
        sendMotorCommand(motors);
        updateMotorStatusDisplay(motors);
        // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é —Å —Ç–µ–∫—É—â–∏–º–∏ —É–≥–ª–∞–º–∏ —Å–µ—Ä–≤–æ
        updateRoverVisualizer(motors, servoAngles);
        lastMotorCommand = motors;
      } else if (currentJoystickMode === 'servo') {
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–æ–ø—Ä–∏–≤–æ–¥–∞–º–∏ –æ—Ç –¥–∂–æ–π—Å—Ç–∏–∫–∞
        // 90¬∞ = –∫–æ–ª—ë—Å–∞ —Å–º–æ—Ç—Ä—è—Ç –ø—Ä—è–º–æ (—Ä–æ–ª–ª–µ—Ä –µ–¥–µ—Ç –≤–ø–µ—Ä—ë–¥)
        // –ü–µ—Ä–µ–¥–Ω–∏–µ (B, A) –≤ –æ–¥–Ω—É —Å—Ç–æ—Ä–æ–Ω—É, –∑–∞–¥–Ω–∏–µ (C, D) –≤ –æ–±—Ä–∞—Ç–Ω—É—é
        
        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º X –¥–∂–æ–π—Å—Ç–∏–∫–∞ (-100...100) –≤ —É–≥–æ–ª —Å–µ—Ä–≤–æ–ø—Ä–∏–≤–æ–¥–∞
        // X = 0 (—Ü–µ–Ω—Ç—Ä) ‚Üí 90¬∞ (–ø—Ä—è–º–æ)
        // X = -100 (–≤–ª–µ–≤–æ) ‚Üí 0¬∞ (–ø–æ–ª–Ω—ã–π –ø–æ–≤–æ—Ä–æ—Ç –≤–ª–µ–≤–æ)
        // X = +100 (–≤–ø—Ä–∞–≤–æ) ‚Üí 180¬∞ (–ø–æ–ª–Ω—ã–π –ø–æ–≤–æ—Ä–æ—Ç –≤–ø—Ä–∞–≤–æ)
        const targetAngle = Math.round(90 - x); // –ò–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º X
        
        // –ú–æ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —É–≥–ª–æ–≤
        // –ü–µ—Ä–µ–¥–Ω–∏–µ –∫–æ–ª—ë—Å–∞ (B=—Å–µ—Ä–≤–æ0, A=—Å–µ—Ä–≤–æ1)
        servoAngles.servo0 = constrain(targetAngle, 0, 180);  // B –ø–µ—Ä–µ–¥–Ω–µ–µ –ª–µ–≤–æ–µ
        servoAngles.servo1 = constrain(targetAngle, 0, 180);  // A –ø–µ—Ä–µ–¥–Ω–µ–µ –ø—Ä–∞–≤–æ–µ
        
        // –ó–∞–¥–Ω–∏–µ –∫–æ–ª—ë—Å–∞ (C=—Å–µ—Ä–≤–æ3, D=—Å–µ—Ä–≤–æ2) –ø–æ–≤–æ—Ä–∞—á–∏–≤–∞—é—Ç—Å—è –≤ –æ–±—Ä–∞—Ç–Ω—É—é —Å—Ç–æ—Ä–æ–Ω—É
        // 180¬∞ - targetAngle –¥–∞—ë—Ç –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—ã–π —É–≥–æ–ª
        servoAngles.servo3 = constrain(180 - targetAngle, 0, 180);  // C –∑–∞–¥–Ω–µ–µ –ª–µ–≤–æ–µ
        servoAngles.servo2 = constrain(180 - targetAngle, 0, 180);  // D –∑–∞–¥–Ω–µ–µ –ø—Ä–∞–≤–æ–µ

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—ã
        const servoCommand = {
          s0: servoAngles.servo0,
          s1: servoAngles.servo1,
          s2: servoAngles.servo2,
          s3: servoAngles.servo3
        };

        if (JSON.stringify(servoCommand) !== JSON.stringify(lastServoCommand)) {
          sendServoCommand(servoCommand);
          lastServoCommand = servoCommand;
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        document.getElementById('joy-motorA').textContent = 'S0:' + servoAngles.servo0;
        document.getElementById('joy-motorB').textContent = 'S1:' + servoAngles.servo1;
        document.getElementById('joy-motorC').textContent = 'S2:' + servoAngles.servo2;
        document.getElementById('joy-motorD').textContent = 'S3:' + servoAngles.servo3;

        // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é —Å–µ—Ä–≤–æ–ø—Ä–∏–≤–æ–¥–æ–≤ –∏ –∫–æ–ª—ë—Å
        updateServoVisualizer(servoAngles);

      } else if (currentJoystickMode === 'mixed') {
        // –°–º–µ—à–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –º–æ—Ç–æ—Ä—ã + —Å–µ—Ä–≤–æ–ø—Ä–∏–≤–æ–¥—ã
        // X –æ—Å—å - –ø–æ–≤–æ—Ä–æ—Ç –∫–æ–ª—ë—Å (—Å–µ—Ä–≤–æ)
        // Y –æ—Å—å - —Å–∫–æ—Ä–æ—Å—Ç—å –º–æ—Ç–æ—Ä–æ–≤
        
        // 1. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–æ–ø—Ä–∏–≤–æ–¥–∞–º–∏ (–ø–æ–≤–æ—Ä–æ—Ç –∫–æ–ª—ë—Å)
        const targetAngle = Math.round(90 - x); // X: -100=180¬∞, 0=90¬∞, +100=0¬∞
        
        // –ü–µ—Ä–µ–¥–Ω–∏–µ –∫–æ–ª—ë—Å–∞ (B=—Å–µ—Ä–≤–æ0, A=—Å–µ—Ä–≤–æ1)
        servoAngles.servo0 = constrain(targetAngle, 0, 180);
        servoAngles.servo1 = constrain(targetAngle, 0, 180);
        
        // –ó–∞–¥–Ω–∏–µ –∫–æ–ª—ë—Å–∞ (C=—Å–µ—Ä–≤–æ3, D=—Å–µ—Ä–≤–æ2) - –≤ –æ–±—Ä–∞—Ç–Ω—É—é —Å—Ç–æ—Ä–æ–Ω—É
        servoAngles.servo3 = constrain(180 - targetAngle, 0, 180);
        servoAngles.servo2 = constrain(180 - targetAngle, 0, 180);
        
        // 2. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ—Ç–æ—Ä–∞–º–∏ (—Å–∫–æ—Ä–æ—Å—Ç—å)
        // Y: -100 = –Ω–∞–∑–∞–¥ (-255), 0 = —Å—Ç–æ–ø (0), +100 = –≤–ø–µ—Ä—ë–¥ (+255)
        const targetSpeed = Math.round(-y * 255 / 100);
        
        const motors = {
          motorA: targetSpeed,
          motorB: targetSpeed,
          motorC: targetSpeed,
          motorD: targetSpeed
        };
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—ã —Å–µ—Ä–≤–æ–ø—Ä–∏–≤–æ–¥–æ–≤
        const servoCommand = {
          s0: servoAngles.servo0,
          s1: servoAngles.servo1,
          s2: servoAngles.servo2,
          s3: servoAngles.servo3
        };
        
        if (JSON.stringify(servoCommand) !== JSON.stringify(lastServoCommand)) {
          sendServoCommand(servoCommand);
          lastServoCommand = servoCommand;
        }
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—ã –º–æ—Ç–æ—Ä–æ–≤
        sendMotorCommand(motors);
        updateMotorStatusDisplay(motors);
        lastMotorCommand = motors;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        document.getElementById('joy-motorA').textContent = 'S:' + servoAngles.servo0 + ' V:' + targetSpeed;
        document.getElementById('joy-motorB').textContent = 'S:' + servoAngles.servo1 + ' V:' + targetSpeed;
        document.getElementById('joy-motorC').textContent = 'S:' + servoAngles.servo2 + ' V:' + targetSpeed;
        document.getElementById('joy-motorD').textContent = 'S:' + servoAngles.servo3 + ' V:' + targetSpeed;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é
        updateRoverVisualizer(motors, servoAngles);
      }
      
      lastSendTime = now;
    }

    function sendMotorCommand(motors) {
      console.log('[Joystick] API request:', motors);
      fetch(API_BASE + '/api/motor', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(motors)
      })
      .then(response => {
        console.log('[Joystick] API response status:', response.status);
        return response.json();
      })
      .then(data => {
        console.log('[Joystick] API response:', data);
      })
      .catch(err => {
        console.error('[Joystick] API error:', err);
      });
    }
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥—ã —Å–µ—Ä–≤–æ–ø—Ä–∏–≤–æ–¥–∞–º
    function sendServoCommand(servoCommand) {
      console.log('[Joystick Servo] Sending:', servoCommand);
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–µ—Ä–≤–æ–ø—Ä–∏–≤–æ–¥–∞ –æ—Ç–¥–µ–ª—å–Ω–æ
      const promises = [];
      
      if (servoCommand.s0 !== undefined) {
        promises.push(
          fetch(API_BASE + '/api/servo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: 0, angle: servoCommand.s0 })
          }).then(r => r.json())
        );
      }
      if (servoCommand.s1 !== undefined) {
        promises.push(
          fetch(API_BASE + '/api/servo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: 1, angle: servoCommand.s1 })
          }).then(r => r.json())
        );
      }
      if (servoCommand.s2 !== undefined) {
        promises.push(
          fetch(API_BASE + '/api/servo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: 2, angle: servoCommand.s2 })
          }).then(r => r.json())
        );
      }
      if (servoCommand.s3 !== undefined) {
        promises.push(
          fetch(API_BASE + '/api/servo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: 3, angle: servoCommand.s3 })
          }).then(r => r.json())
        );
      }
      
      Promise.all(promises)
        .then(results => {
          console.log('[Joystick Servo] Results:', results);
        })
        .catch(err => {
          console.error('[Joystick Servo] Error:', err);
        });
    }

    function updateMotorStatusDisplay(motors) {
      document.getElementById('joy-motorA').textContent = motors.motorA;
      document.getElementById('joy-motorB').textContent = motors.motorB;
      document.getElementById('joy-motorC').textContent = motors.motorC;
      document.getElementById('joy-motorD').textContent = motors.motorD;
    }

    // ===== –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ä–æ–≤–µ—Ä–∞ =====
    function updateRoverVisualizer(motors, servoAngles) {
      // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: 0-B(–ª–µ–≤), 1-A(–ø—Ä–∞–≤), 2-D(–ø—Ä–∞–≤), 3-C(–ª–µ–≤)
      // –õ–µ–≤—ã–µ: B, C | –ü—Ä–∞–≤—ã–µ: A, D
      
      const motorA = motors.motorA || 0;
      const motorB = motors.motorB || 0;
      const motorC = motors.motorC || 0;
      const motorD = motors.motorD || 0;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–æ–ª–µ—Å–∞
      updateWheelVisual('wheel-a', motorA, servoAngles.servo1, 'right');
      updateWheelVisual('wheel-b', motorB, servoAngles.servo0, 'left');
      updateWheelVisual('wheel-c', motorC, servoAngles.servo3, 'left');
      updateWheelVisual('wheel-d', motorD, servoAngles.servo2, 'right');
    }

    function updateWheelVisual(wheelId, speed, servoAngle, side) {
      const wheel = document.getElementById(wheelId);
      const servoArrow = wheel.querySelector('.servo-arrow');
      const speedArrowLine = wheel.querySelector('.speed-arrow-line');
      const speedText = wheel.querySelector('.speed-text');
      const servoAngleText = wheel.querySelector('.servo-angle-text');
      
      // 1. –ü–æ–≤–æ—Ä–æ—Ç —Å—Ç—Ä–µ–ª–∫–∏ —Å–µ—Ä–≤–æ–ø—Ä–∏–≤–æ–¥–∞
      // –í SVG —Å—Ç—Ä–µ–ª–∫–∞ –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ –ø–æ–≤—ë—Ä–Ω—É—Ç–∞ –Ω–∞ -90¬∞ (—Å–º–æ—Ç—Ä–∏—Ç –≤–≤–µ—Ä—Ö)
      // –ü—Ä–∏ 90¬∞ —Å–µ—Ä–≤–æ —Å—Ç—Ä–µ–ª–∫–∞ –¥–æ–ª–∂–Ω–∞ —Å–º–æ—Ç—Ä–µ—Ç—å –≤–≤–µ—Ä—Ö = –ø–æ–≤–æ—Ä–æ—Ç 0¬∞
      // –ü—Ä–∏ 0¬∞ —Å–µ—Ä–≤–æ —Å—Ç—Ä–µ–ª–∫–∞ –¥–æ–ª–∂–Ω–∞ —Å–º–æ—Ç—Ä–µ—Ç—å –≤–ª–µ–≤–æ = –ø–æ–≤–æ—Ä–æ—Ç -90¬∞
      // –ü—Ä–∏ 180¬∞ —Å–µ—Ä–≤–æ —Å—Ç—Ä–µ–ª–∫–∞ –¥–æ–ª–∂–Ω–∞ —Å–º–æ—Ç—Ä–µ—Ç—å –≤–ø—Ä–∞–≤–æ = –ø–æ–≤–æ—Ä–æ—Ç +90¬∞
      // 
      // –ù–æ –≤ SVG —Å—Ç—Ä–µ–ª–∫–∞ –Ω–∞—Ä–∏—Å–æ–≤–∞–Ω–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ (—Å–º–æ—Ç—Ä–∏—Ç –≤–ø—Ä–∞–≤–æ –ø—Ä–∏ 0¬∞)
      // –ü–æ—ç—Ç–æ–º—É: 90¬∞ —Å–µ—Ä–≤–æ = —Å—Ç—Ä–µ–ª–∫–∞ –≤–≤–µ—Ä—Ö = –ø–æ–≤–æ—Ä–æ—Ç -90¬∞ –æ—Ç –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏
      // –§–æ—Ä–º—É–ª–∞: rotation = servoAngle - 180
      const arrowRotation = servoAngle - 180;
      servoArrow.setAttribute('transform', `rotate(${arrowRotation})`);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç —É–≥–ª–∞
      if (servoAngleText) {
        servoAngleText.textContent = servoAngle + '¬∞';
      }
      
      // 2. –°—Ç—Ä–µ–ª–∫–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏
      // –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –≤–ø–µ—Ä—ë–¥ (–≤–Ω–∏–∑) –∏–ª–∏ –Ω–∞–∑–∞–¥ (–≤–≤–µ—Ä—Ö)
      // –î–ª–∏–Ω–∞ –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏ (–º–∞–∫—Å 255 = 40px)
      const arrowLength = Math.abs(speed) * 40 / 255;
      const minArrowLength = speed !== 0 ? 8 : 0;
      const finalLength = Math.max(minArrowLength, arrowLength);
      
      const direction = speed >= 0 ? 1 : -1; // 1 = –≤–ø–µ—Ä—ë–¥ (–≤–Ω–∏–∑), -1 = –Ω–∞–∑–∞–¥ (–≤–≤–µ—Ä—Ö)
      
      // –†–∏—Å—É–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—É—é —Å—Ç—Ä–µ–ª–∫—É
      const endY = direction * finalLength;
      speedArrowLine.setAttribute('x1', 0);
      speedArrowLine.setAttribute('y1', 0);
      speedArrowLine.setAttribute('x2', 0);
      speedArrowLine.setAttribute('y2', endY);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏
      if (speedText) {
        speedText.textContent = Math.abs(speed);
      }
      
      // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–ª—ë—Å
      const ellipse = wheel.querySelector('ellipse');
      if (Math.abs(speed) > 10) {
        ellipse.classList.add(side === 'left' ? 'wheel-active-left' : 'wheel-active-right');
      } else {
        ellipse.classList.remove('wheel-active-left', 'wheel-active-right');
      }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É–≥–ª–æ–≤ —Å–µ—Ä–≤–æ–ø—Ä–∏–≤–æ–¥–æ–≤ –Ω–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ (—Ä–µ–∂–∏–º servo)
    function updateServoVisualizer(servoAngles) {
      // –î–ª—è —Ä–µ–∂–∏–º–∞ —Å–µ—Ä–≤–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–≤–µ—Å—Ç–Ω—ã–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ –º–æ—Ç–æ—Ä–æ–≤
      // –∏–ª–∏ 0 –µ—Å–ª–∏ –º–æ—Ç–æ—Ä—ã –Ω–µ –¥–≤–∏–≥–∞—é—Ç—Å—è
      updateRoverVisualizer({
        motorA: 0, motorB: 0, motorC: 0, motorD: 0
      }, servoAngles);
    }

    function setJoystickMode(mode) {
      currentJoystickMode = mode;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
      document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
      
      showMessage('–†–µ–∂–∏–º: ' + mode, 'success');
    }

    function stopAllMotorsFromJoystick() {
      stopAllMotors();
      document.getElementById('joy-motorA').textContent = '0';
      document.getElementById('joy-motorB').textContent = '0';
      document.getElementById('joy-motorC').textContent = '0';
      document.getElementById('joy-motorD').textContent = '0';
      document.getElementById('joy-x').textContent = '0';
      document.getElementById('joy-y').textContent = '0';
    }

    function stopMotorsSmooth() {
      sendMotorCommand({
        motorA: 0,
        motorB: 0,
        motorC: 0,
        motorD: 0
      });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è (constrain)
    function constrain(value, min, max) {
      return Math.max(min, Math.min(max, value));
    }
  </script>
</body>
</html>
